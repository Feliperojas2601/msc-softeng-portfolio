name: CI release → main

on:
  push:
    branches:
      - develop

permissions:
  contents: write

jobs:
  release-job:
    if: ${{ contains(github.event.head_commit.message, 'CREAR_RELEASE') }}
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout del código  
      - name: Checkout del repositorio
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      # 2. Configurar Python
      - name: Configuración de entorno python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3. Instalar dependencias
      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Extraer número de versión desde commit (ej: CREAR_RELEASE_1.0.0)
      - name: Obtener versión desde commit
        id: version
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          VERSION=$(echo $COMMIT_MSG | grep -oE 'CREAR_RELEASE_[0-9]+\.[0-9]+\.[0-9]+' | sed 's/CREAR_RELEASE_//')
          if [ -z "$VERSION" ]; then
            echo "No se encontró versión en el commit, abortando"
            exit 1
          fi
          echo "Versión detectada: $VERSION"
          echo "::set-output name=version::$VERSION"

      # 5. Crear rama release desde develop
      - name: Crear rama release
        run: |
          git checkout -b release/${{ steps.version.outputs.version }}
          git push -u origin release/${{ steps.version.outputs.version }}

      # 6. Correr pruebas
      - name: Correr pruebas
        run: python -m unittest discover -s tests

      # 7. Mezclar release → main si las pruebas pasan
      - name: Mezclar release → main
        if: success()
        uses: tukasz/direct-merge-action@master
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          source-branch: release/${{ steps.version.outputs.version }}
          target-branch: main

      # 5. Crear el tag correspondiente en main
      - name: Crear tag en main
        if: success()
        run: |
          git fetch origin main
          git checkout main 
          git tag v${{ steps.version.outputs.version }}
          git push origin v${{ steps.version.outputs.version }}